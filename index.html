<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞–≥–∞–π (–ö–ü–ü)</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
    min-height: 100vh;
    padding: 20px;
    color: #333;
}

.app-container {
    max-width: 800px;
    margin: 0 auto;
}

.screen {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.hidden {
    display: none !important;
}

.card {
    background: white;
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 20px;
    box-shadow: 0 8px 32px rgba(142, 82, 211, 0.2);
}

.app-title {
    color: #8b5cf6;
    font-size: 2em;
    text-align: center;
    margin-bottom: 10px;
}

.subtitle {
    text-align: center;
    color: #666;
    margin-bottom: 30px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    color: #8b5cf6;
    font-weight: 600;
    margin-bottom: 8px;
}

.form-group input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0c3fc;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.3s ease;
}

.form-group input:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
    color: white;
    width: 100%;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
}

.btn-secondary {
    background: #e0c3fc;
    color: #8b5cf6;
    width: 100%;
    margin-top: 10px;
}

.btn-secondary:hover {
    background: #d4b3fc;
}

.btn-small {
    padding: 8px 16px;
    font-size: 14px;
    background: #f3e8ff;
    color: #8b5cf6;
}

.btn-small:hover {
    background: #e9d5ff;
}

.btn-danger {
    background: #ef4444;
    color: white;
    width: 100%;
}

.btn-danger:hover {
    background: #dc2626;
}

.existing-users {
    margin-top: 30px;
}

.user-card {
    background: #f3e8ff;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.user-card button {
    padding: 8px 16px;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    background: white;
    padding: 20px;
    border-radius: 20px;
    box-shadow: 0 4px 16px rgba(142, 82, 211, 0.15);
}

.user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.user-info span {
    color: #8b5cf6;
    font-weight: 600;
    font-size: 1.1em;
}

.nav-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    background: white;
    padding: 10px;
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(142, 82, 211, 0.15);
}

.tab-btn {
    flex: 1;
    padding: 12px;
    border: none;
    background: transparent;
    color: #8b5cf6;
    font-weight: 600;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tab-btn:hover {
    background: #f3e8ff;
}

.tab-btn.active {
    background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
    color: white;
}

.date-display {
    text-align: center;
    font-size: 1.1em;
    color: #666;
    margin-bottom: 20px;
}

.goal-display {
    background: linear-gradient(135deg, #f3e8ff 0%, #e0c3fc 100%);
    padding: 20px;
    border-radius: 16px;
    margin-bottom: 25px;
}

.goal-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.goal-item:last-child {
    margin-bottom: 0;
}

.goal-label {
    color: #8b5cf6;
    font-weight: 600;
}

.goal-value {
    color: #6d28d9;
    font-size: 1.5em;
    font-weight: 700;
}

.result-card {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    padding: 20px;
    border-radius: 16px;
    margin-bottom: 15px;
}

.result-card.warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
}

.result-card.error {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
}

.result-stats {
    margin-top: 15px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    color: #333;
}

.comparison-grid {
    display: grid;
    gap: 15px;
    margin-top: 15px;
}

.user-comparison-card {
    background: linear-gradient(135deg, #f3e8ff 0%, #e0c3fc 100%);
    padding: 20px;
    border-radius: 16px;
}

.user-comparison-card.current-user {
    background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
    color: white;
}

.user-comparison-card h4 {
    margin-bottom: 15px;
}

.progress-bar {
    background: rgba(255, 255, 255, 0.3);
    height: 30px;
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.9em;
}

.treadmill-progress {
    margin-top: 10px;
}

.treadmill-progress .progress-fill {
    background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
}

.history-list {
    display: grid;
    gap: 15px;
}

.history-item {
    background: #f3e8ff;
    padding: 20px;
    border-radius: 16px;
    border-left: 4px solid #8b5cf6;
}

.history-item.completed {
    border-left-color: #10b981;
}

.history-item.partial {
    border-left-color: #f59e0b;
}

.history-item.failed {
    border-left-color: #ef4444;
}

.history-date {
    font-weight: 700;
    color: #8b5cf6;
    margin-bottom: 10px;
}

.history-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.history-stat {
    font-size: 0.9em;
    color: #666;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 600;
    margin-top: 10px;
}

.status-badge.success {
    background: #d1fae5;
    color: #065f46;
}

.status-badge.warning {
    background: #fef3c7;
    color: #92400e;
}

.status-badge.error {
    background: #fee2e2;
    color: #991b1b;
}

.stats-period {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.stats-grid {
    display: grid;
    gap: 20px;
    margin-top: 20px;
}

.stat-card {
    background: linear-gradient(135deg, #f3e8ff 0%, #e0c3fc 100%);
    padding: 20px;
    border-radius: 16px;
    text-align: center;
}

.stat-value {
    font-size: 2.5em;
    font-weight: 700;
    color: #8b5cf6;
    margin: 10px 0;
}

.stat-label {
    color: #666;
    font-weight: 600;
}

.chart-container {
    background: white;
    padding: 20px;
    border-radius: 16px;
    margin-top: 20px;
}

.bar-chart {
    display: flex;
    align-items: flex-end;
    justify-content: space-around;
    height: 250px;
    gap: 10px;
}

.bar-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
}

.bar {
    width: 100%;
    background: linear-gradient(180deg, #8b5cf6 0%, #a78bfa 100%);
    border-radius: 8px 8px 0 0;
    transition: all 0.3s ease;
    min-height: 5px;
    position: relative;
}

.bar-label {
    margin-top: 8px;
    font-size: 0.85em;
    color: #666;
    font-weight: 600;
}

.bar-value {
    position: absolute;
    top: -25px;
    width: 100%;
    text-align: center;
    font-size: 0.8em;
    font-weight: 600;
    color: #8b5cf6;
}

.danger-zone {
    margin-top: 40px;
    padding-top: 30px;
    border-top: 2px solid #fee2e2;
}

.danger-zone h3 {
    color: #ef4444;
    margin-bottom: 15px;
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: #999;
}

.empty-state::before {
    content: "üì≠";
    display: block;
    font-size: 3em;
    margin-bottom: 15px;
}

@media (max-width: 600px) {
    body {
        padding: 10px;
    }

    .card {
        padding: 20px;
    }

    .app-title {
        font-size: 1.5em;
    }

    .header {
        flex-direction: column;
        gap: 15px;
    }

    .nav-tabs {
        flex-direction: column;
    }

    .history-stats {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <div id="registration-screen" class="screen">
            <div class="card">
                <h1 class="app-title">üö∂‚Äç‚ôÄÔ∏è –®–∞–≥–∞–π (–ö–ü–ü)</h1>
                <p class="subtitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω—ë–º</p>

                <div class="form-group">
                    <label>–í–∞—à–µ –∏–º—è:</label>
                    <input type="text" id="reg-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                </div>

                <div class="form-group">
                    <label>–°—Ç–∞—Ä—Ç–æ–≤–∞—è –Ω–æ—Ä–º–∞ —à–∞–≥–æ–≤ (–î–µ–Ω—å 0):</label>
                    <input type="number" id="reg-base-steps" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 5000" min="0">
                </div>

                <div class="form-group">
                    <label>–î–Ω–µ–≤–Ω–∞—è –Ω–æ—Ä–º–∞ –¥–æ—Ä–æ–∂–∫–∏:</label>
                    <input type="number" id="reg-treadmill-goal" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 2000 (–∏–ª–∏ 0)" min="0" value="2000">
                </div>

                <button class="btn btn-primary" onclick="registerUser()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>

                <div id="existing-users" class="existing-users"></div>
            </div>
        </div>

        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="main-screen" class="screen hidden">
            <div class="header">
                <h1 class="app-title">üö∂‚Äç‚ôÄÔ∏è –®–∞–≥–∞–π (–ö–ü–ü)</h1>
                <div class="user-info">
                    <span id="current-user-name"></span>
                    <button class="btn btn-small" onclick="switchUser()">–°–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="tab-btn active" data-tab="today" onclick="showTab('today', this)">–°–µ–≥–æ–¥–Ω—è</button>
                <button class="tab-btn" data-tab="history" onclick="showTab('history', this)">–ò—Å—Ç–æ—Ä–∏—è</button>
                <button class="tab-btn" data-tab="stats" onclick="showTab('stats', this)">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                <button class="tab-btn" data-tab="settings" onclick="showTab('settings', this)">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ "–°–µ–≥–æ–¥–Ω—è" -->
            <div id="tab-today" class="tab-content">
                <div class="card">
                    <h2>üìÖ –°–µ–≥–æ–¥–Ω—è</h2>
                    <div class="date-display" id="today-date"></div>

                    <div class="goal-display">
                        <div class="goal-item">
                            <span class="goal-label">–î–Ω–µ–≤–Ω–∞—è –Ω–æ—Ä–º–∞:</span>
                            <span class="goal-value" id="today-goal">0</span> —à–∞–≥–æ–≤
                        </div>
                        <div class="goal-item">
                            <span class="goal-label">–ù–æ—Ä–º–∞ –¥–æ—Ä–æ–∂–∫–∏:</span>
                            <span class="goal-value" id="treadmill-goal-display">0</span> —à–∞–≥–æ–≤
                        </div>
                    </div>

                    <div id="today-form">
                        <div class="form-group">
                            <label>–í—Å–µ–≥–æ —à–∞–≥–æ–≤ –∑–∞ –¥–µ–Ω—å:</label>
                            <input type="number" id="input-total-steps" placeholder="0" min="0">
                        </div>

                        <div class="form-group">
                            <label>–ò–∑ –Ω–∏—Ö –Ω–∞ –¥–æ—Ä–æ–∂–∫–µ:</label>
                            <input type="number" id="input-treadmill-steps" placeholder="0" min="0">
                        </div>

                        <button class="btn btn-primary" onclick="saveToday()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
                    </div>

                    <div id="today-result" class="hidden">
                        <div class="result-card" id="result-message"></div>
                        <button class="btn btn-secondary" onclick="editToday()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>

                <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
                <div class="card" id="today-comparison">
                    <h3>üë• –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
                    <div id="today-comparison-content"></div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ "–ò—Å—Ç–æ—Ä–∏—è" -->
            <div id="tab-history" class="tab-content hidden">
                <div class="card">
                    <h2>üìä –ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
                    <div id="history-content"></div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" -->
            <div id="tab-stats" class="tab-content hidden">
                <div class="card">
                    <h2>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>

                    <div class="stats-period">
                        <button class="btn btn-small" onclick="showStats('day')">–î–µ–Ω—å</button>
                        <button class="btn btn-small" onclick="showStats('week')">–ù–µ–¥–µ–ª—è</button>
                        <button class="btn btn-small" onclick="showStats('month')">–ú–µ—Å—è—Ü</button>
                    </div>

                    <div id="stats-content"></div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" -->
            <div id="tab-settings" class="tab-content hidden">
                <div class="card">
                    <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

                    <div class="form-group">
                        <label>–¢–µ–∫—É—â–∞—è –±–∞–∑–æ–≤–∞—è –Ω–æ—Ä–º–∞ —à–∞–≥–æ–≤:</label>
                        <input type="number" id="settings-base-steps" min="0">
                    </div>

                    <div class="form-group">
                        <label>–ù–æ—Ä–º–∞ –¥–æ—Ä–æ–∂–∫–∏:</label>
                        <input type="number" id="settings-treadmill-goal" min="0">
                    </div>

                    <button class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>

                    <div class="danger-zone">
                        <h3>‚ö†Ô∏è –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h3>
                        <button class="btn btn-danger" onclick="deleteAccount()">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
<script type="module">
// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Firebase + Firestore
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
    getFirestore, doc, getDoc, getDocs, setDoc, updateDoc, addDoc,
    collection, query, where, serverTimestamp, writeBatch
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDyB_fMhK3hhJT27lBjqg9-gU7jETau0q4",
  authDomain: "shagai-kpp.firebaseapp.com",
  projectId: "shagai-kpp",
  storageBucket: "shagai-kpp.firebasestorage.app",
  messagingSenderId: "75634018360",
  appId: "1:75634018360:web:a03d961efadc653b5f3ecd",
  measurementId: "G-3DGDG0BVT1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ =====
let currentUser = null;
let currentUserHistory = {};

// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏
const formatDate = (date) => {
    const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
    return date.toLocaleDateString('ru-RU', options);
};

const getDateKey = (date) => {
    return date.toISOString().split('T')[0];
};

const getTodayKey = () => {
    return getDateKey(new Date());
};

// –†–∞–±–æ—Ç–∞ —Å localStorage (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
const getCurrentUserId = () => {
    return localStorage.getItem('stepTracker_currentUser');
};

const setCurrentUserId = (userId) => {
    localStorage.setItem('stepTracker_currentUser', userId);
};

const clearCurrentUserId = () => {
    localStorage.removeItem('stepTracker_currentUser');
};

// ===== Firestore: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –∏—Å—Ç–æ—Ä–∏—è =====
const usersCollection = collection(db, 'users');

const fetchAllUsers = async () => {
    const snap = await getDocs(usersCollection);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
};

const fetchUserById = async (id) => {
    const ref = doc(db, 'users', id);
    const snap = await getDoc(ref);
    if (!snap.exists()) return null;
    return { id, ...snap.data() };
};

const findUserByName = async (name) => {
    const q = query(usersCollection, where('name', '==', name));
    const snap = await getDocs(q);
    if (snap.empty) return null;
    const d = snap.docs[0];
    return { id: d.id, ...d.data() };
};

const createUser = async (name, baseSteps, treadmillGoal) => {
    const docRef = await addDoc(usersCollection, {
        name,
        baseSteps,
        treadmillGoal,
        createdAt: serverTimestamp()
    });
    return { id: docRef.id, name, baseSteps, treadmillGoal };
};

const updateUserInFirestore = async (userId, data) => {
    const ref = doc(db, 'users', userId);
    await updateDoc(ref, data);
};

const historyCollectionForUser = (userId) => collection(db, 'users', userId, 'history');

const loadHistoryForUser = async (userId) => {
    const snap = await getDocs(historyCollectionForUser(userId));
    const res = {};
    snap.forEach(d => {
        res[d.id] = d.data();
    });
    return res;
};

const loadEntryForUserDate = async (userId, dateKey) => {
    const ref = doc(db, 'users', userId, 'history', dateKey);
    const snap = await getDoc(ref);
    return snap.exists() ? snap.data() : null;
};

const saveEntryForUserDate = async (userId, dateKey, entry) => {
    const ref = doc(db, 'users', userId, 'history', dateKey);
    await setDoc(ref, entry);
};

// –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
const getMotivationMessage = (result) => {
    const messages = {
        perfect: [
            "–°—É–ø–µ—Ä! –¶–µ–ª—å –∑–∞–∫—Ä—ã—Ç–∞ üéâ",
            "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ üí™",
            "–ú–æ—â–Ω–æ! –°–µ–≥–æ–¥–Ω—è –Ω–∞ –≤—ã—Å–æ—Ç–µ üåü",
            "–ë—Ä–∞–≤–æ! –ò–¥–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚ú®",
            "–¢—ã –Ω–∞ –æ–≥–Ω–µ! –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å üî•"
        ],
        treadmillOnly: [
            "–°–µ–≥–æ–¥–Ω—è –º–æ—â–Ω–æ! –î–æ—Ä–æ–∂–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ üí™",
            "–î–æ—Ä–æ–∂–∫–∞ –ø–æ–∫–æ—Ä–µ–Ω–∞! –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ üéØ",
            "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–∞ –¥–æ—Ä–æ–∂–∫–µ! üèÉ‚Äç‚ôÄÔ∏è"
        ],
        stepsOnly: [
            "–ù–æ—Ä–º–∞ —à–∞–≥–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å üëè",
            "–®–∞–≥–∏ –∑–∞—á—Ç–µ–Ω—ã! –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ üö∂‚Äç‚ôÄÔ∏è",
            "–î–Ω–µ–≤–Ω–∞—è —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞! –û—Ç–ª–∏—á–Ω–æ üí´"
        ],
        close: [
            "–°–æ–≤—Å–µ–º —á—É—Ç—å-—á—É—Ç—å –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ ‚Äî –∑–∞–≤—Ç—Ä–∞ –Ω–∞–≤–µ—Ä—Å—Ç–∞–µ–º üî•",
            "–ü–æ—á—Ç–∏ –∏–¥–µ–∞–ª—å–Ω–æ! –ï—â—ë –Ω–µ–º–Ω–æ–≥–æ —É—Å–∏–ª–∏–π üí™",
            "–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –ó–∞–≤—Ç—Ä–∞ –±—É–¥–µ—Ç –ª—É—á—à–µ üåà",
            "–°—Ç–∞–±–∏–ª—å–Ω–æ –¥–≤–∏–∂–µ—à—å—Å—è –≤–ø–µ—Ä—ë–¥! üìà"
        ],
        tryAgain: [
            "–°–µ–≥–æ–¥–Ω—è –Ω–µ —Å–ª–æ–∂–∏–ª–æ—Å—å, –Ω–æ –∑–∞–≤—Ç—Ä–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å! üåÖ",
            "–ù–µ —Å–¥–∞–≤–∞–π—Å—è! –ö–∞–∂–¥—ã–π —à–∞–≥ –≤–∞–∂–µ–Ω üíô",
            "–ë—ã–≤–∞–µ—Ç! –ì–ª–∞–≤–Ω–æ–µ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥–≤–∏–≥–∞—Ç—å—Å—è üöÄ",
            "–ó–∞–≤—Ç—Ä–∞ —Ç–æ—á–Ω–æ –ø–æ–ª—É—á–∏—Ç—Å—è –ª—É—á—à–µ! üí™"
        ]
    };

    const random = (arr) => arr[Math.floor(Math.random() * arr.length)];

    if (result.stepsAchieved && result.treadmillAchieved) {
        return random(messages.perfect);
    } else if (result.treadmillAchieved && !result.stepsAchieved) {
        return random(messages.treadmillOnly);
    } else if (result.stepsAchieved && !result.treadmillAchieved) {
        return random(messages.stepsOnly);
    } else if (result.stepsPercent >= 80 || result.treadmillPercent >= 80) {
        return random(messages.close);
    } else {
        return random(messages.tryAgain);
    }
};

// –†–∞—Å—á—ë—Ç –¥–Ω–µ–≤–Ω–æ–π –Ω–æ—Ä–º—ã –ø–æ –∏—Å—Ç–æ—Ä–∏–∏
const calculateTodayGoal = (user) => {
    const history = user.history;
    const days = Object.keys(history).length;

    // –ù–æ—Ä–º–∞ = –±–∞–∑–æ–≤–∞—è + (–∫–æ–ª-–≤–æ –¥–Ω–µ–π * 100)
    const goal = user.baseSteps + (days * 100);

    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É
    return Math.min(goal, 10000);
};

// ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è =====
const init = async () => {
    try {
        const userId = getCurrentUserId();
        if (userId) {
            const user = await fetchUserById(userId);
            if (user) {
                currentUser = user;
                await showMainScreen();
                return;
            } else {
                clearCurrentUserId();
            }
        }
        await showRegistration();
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', err);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
    }
};

// ===== –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ =====
const showRegistration = async () => {
    document.getElementById('registration-screen').classList.remove('hidden');
    document.getElementById('main-screen').classList.add('hidden');
    document.getElementById('reg-name').value = '';
    document.getElementById('reg-base-steps').value = '';
    // treadGoal –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å (2000 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    await displayExistingUsers();
};

const displayExistingUsers = async () => {
    const container = document.getElementById('existing-users');
    try {
        const users = await fetchAllUsers();
        if (!users.length) {
            container.innerHTML = '';
            return;
        }
        container.innerHTML = '<h3 style="color: #8b5cf6; margin-bottom: 15px;">–ò–ª–∏ –≤–æ–π—Ç–∏ –∫–∞–∫:</h3>';
        users.forEach(user => {
            const userCard = document.createElement('div');
            userCard.className = 'user-card';
            userCard.innerHTML = `
                <span style="font-weight: 600; color: #8b5cf6;">${user.name}</span>
                <button class="btn btn-small" onclick="loginUser('${user.id}')">–í–æ–π—Ç–∏</button>
            `;
            container.appendChild(userCard);
        });
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', err);
        container.innerHTML = '<p style="color:#ef4444;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>';
    }
};

const registerUser = async () => {
    const name = document.getElementById('reg-name').value.trim();
    const baseSteps = parseInt(document.getElementById('reg-base-steps').value);
    const treadmillGoal = parseInt(document.getElementById('reg-treadmill-goal').value) || 0;

    if (!name) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è');
        return;
    }

    if (isNaN(baseSteps) || baseSteps < 0) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞—Ä—Ç–æ–≤—É—é –Ω–æ—Ä–º—É');
        return;
    }

    try {
        const existing = await findUserByName(name);
        if (existing) {
            const isYou = confirm(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –≠—Ç–æ –≤—ã?`);
            if (isYou) {
                currentUser = existing;
                setCurrentUserId(existing.id);
                await showMainScreen();
            } else {
                alert('–≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ.');
            }
            return;
        }

        const newUser = await createUser(name, baseSteps, treadmillGoal);
        currentUser = newUser;
        setCurrentUserId(newUser.id);
        await showMainScreen();
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
    }
};

const loginUser = async (userId) => {
    try {
        const user = await fetchUserById(userId);
        if (!user) {
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        currentUser = user;
        setCurrentUserId(userId);
        await showMainScreen();
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
    }
};

// ===== –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω =====
const showMainScreen = async () => {
    if (!currentUser) return;
    document.getElementById('registration-screen').classList.add('hidden');
    document.getElementById('main-screen').classList.remove('hidden');
    document.getElementById('current-user-name').textContent = currentUser.name || '';
    await showTab('today');
};

const switchUser = async () => {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–º–µ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
    clearCurrentUserId();
    currentUser = null;
    currentUserHistory = {};
    await showRegistration();
};

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∞–º–∏
const showTab = async (tabName, buttonEl) => {
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });

    // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    if (!buttonEl) {
        buttonEl = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
    }
    if (buttonEl) {
        buttonEl.classList.add('active');
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    const tab = document.getElementById(`tab-${tabName}`);
    if (tab) tab.classList.remove('hidden');

    // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    if (tabName === 'today') {
        await updateTodayTab();
    } else if (tabName === 'history') {
        await updateHistoryTab();
    } else if (tabName === 'stats') {
        await showStats('day');
    } else if (tabName === 'settings') {
        await updateSettingsTab();
    }
};

// ===== –í–∫–ª–∞–¥–∫–∞ "–°–µ–≥–æ–¥–Ω—è" =====
const updateTodayTab = async () => {
    if (!currentUser) return;
    const todayKey = getTodayKey();

    document.getElementById('today-date').textContent = formatDate(new Date());

    // –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    currentUserHistory = await loadHistoryForUser(currentUser.id);
    const todayEntry = currentUserHistory[todayKey];

    const todayGoal = calculateTodayGoal(currentUser.baseSteps, currentUserHistory);
    document.getElementById('today-goal').textContent = todayGoal.toLocaleString();
    document.getElementById('treadmill-goal-display').textContent = currentUser.treadmillGoal.toLocaleString();

    if (todayEntry) {
        showTodayResult(todayEntry, todayGoal, currentUser.treadmillGoal);
    } else {
        showTodayForm();
    }

    await updateTodayComparison();
};

const showTodayForm = () => {
    document.getElementById('today-form').classList.remove('hidden');
    document.getElementById('today-result').classList.add('hidden');
    document.getElementById('input-total-steps').value = '';
    document.getElementById('input-treadmill-steps').value = '';
};

const showTodayResult = (entry, goal, treadmillGoal) => {
    document.getElementById('today-form').classList.add('hidden');
    document.getElementById('today-result').classList.remove('hidden');

    const stepsPercent = Math.round((entry.totalSteps / goal) * 100);
    const treadmillPercent = treadmillGoal > 0
        ? Math.round((entry.treadmillSteps / treadmillGoal) * 100)
        : 100;

    const stepsAchieved = entry.totalSteps >= goal;
    const treadmillAchieved = treadmillGoal === 0 || entry.treadmillSteps >= treadmillGoal;

    const result = {
        stepsAchieved,
        treadmillAchieved,
        stepsPercent,
        treadmillPercent
    };

    const message = getMotivationMessage(result);

    let cardClass = 'result-card';
    if (stepsAchieved && treadmillAchieved) {
        cardClass += ' success';
    } else if (stepsPercent >= 80 || treadmillPercent >= 80) {
        cardClass += ' warning';
    } else {
        cardClass += ' error';
    }

    const resultHtml = `
        <div class="${cardClass}">
            <h3 style="margin-bottom: 15px;">${message}</h3>
            <div class="result-stats">
                <div class="stat-row">
                    <span>–í—Å–µ–≥–æ —à–∞–≥–æ–≤:</span>
                    <strong>${entry.totalSteps.toLocaleString()} / ${goal.toLocaleString()}</strong>
                </div>
                <div class="stat-row">
                    <span>–ü—Ä–æ–≥—Ä–µ—Å—Å:</span>
                    <strong>${stepsPercent}%</strong>
                </div>
                <div class="stat-row">
                    <span>–î–æ—Ä–æ–∂–∫–∞:</span>
                    <strong>${entry.treadmillSteps.toLocaleString()} / ${treadmillGoal.toLocaleString()}</strong>
                </div>
                <div class="stat-row">
                    <span>–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ—Ä–æ–∂–∫–∏:</span>
                    <strong>${treadmillPercent}%</strong>
                </div>
            </div>
        </div>
    `;

    const container = document.getElementById('today-result');
    container.querySelector('.result-card')?.remove();
    container.insertAdjacentHTML('afterbegin', resultHtml);
};

const saveToday = async () => {
    if (!currentUser) return;
    const totalSteps = parseInt(document.getElementById('input-total-steps').value);
    const treadmillSteps = parseInt(document.getElementById('input-treadmill-steps').value) || 0;

    if (isNaN(totalSteps) || totalSteps < 0) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤');
        return;
    }

    if (treadmillSteps < 0) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤ –Ω–∞ –¥–æ—Ä–æ–∂–∫–µ');
        return;
    }

    if (treadmillSteps > totalSteps) {
        alert('–®–∞–≥–∏ –Ω–∞ –¥–æ—Ä–æ–∂–∫–µ –Ω–µ –º–æ–≥—É—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤');
        return;
    }

    const todayKey = getTodayKey();
    currentUserHistory = await loadHistoryForUser(currentUser.id);
    const goal = calculateTodayGoal(currentUser.baseSteps, currentUserHistory);

    const entry = {
        date: todayKey,
        totalSteps,
        treadmillSteps,
        goal,
        treadmillGoal: currentUser.treadmillGoal,
        timestamp: new Date().toISOString()
    };

    await saveEntryForUserDate(currentUser.id, todayKey, entry);
    currentUserHistory[todayKey] = entry;

    await updateTodayTab();
};

const editToday = async () => {
    if (!currentUser) return;
    const todayKey = getTodayKey();
    let entry = currentUserHistory[todayKey];
    if (!entry) {
        entry = await loadEntryForUserDate(currentUser.id, todayKey);
    }
    if (!entry) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Å–µ–≥–æ–¥–Ω—è');
        return;
    }
    document.getElementById('input-total-steps').value = entry.totalSteps;
    document.getElementById('input-treadmill-steps').value = entry.treadmillSteps;
    showTodayForm();
};

// –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è
const updateTodayComparison = async () => {
    const container = document.getElementById('today-comparison-content');
    container.innerHTML = '';
    if (!currentUser) return;

    try {
        const users = await fetchAllUsers();
        const todayKey = getTodayKey();

        const entries = await Promise.all(
            users.map(async (user) => {
                const entry = await loadEntryForUserDate(user.id, todayKey);
                return { user, entry };
            })
        );

        const usersWithData = entries.filter(item => item.entry);
        if (!usersWithData.length) {
            container.innerHTML = '<p style="text-align: center; color: #999;">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</p>';
            return;
        }

        const comparisonGrid = document.createElement('div');
        comparisonGrid.className = 'comparison-grid';

        usersWithData.forEach(({ user, entry }) => {
            const goal = entry.goal;
            const treadmillGoal = entry.treadmillGoal;
            const stepsPercent = Math.min(Math.round((entry.totalSteps / goal) * 100), 100);
            const treadmillPercent = treadmillGoal > 0
                ? Math.min(Math.round((entry.treadmillSteps / treadmillGoal) * 100), 100)
                : 100;

            const isCurrentUser = currentUser && user.id === currentUser.id;

            const card = document.createElement('div');
            card.className = 'user-comparison-card' + (isCurrentUser ? ' current-user' : '');
            card.innerHTML = `
                <h4>${user.name} ${isCurrentUser ? '(–≤—ã)' : ''}</h4>
                <div>
                    <div style="margin-bottom: 5px;">
                        <small>–®–∞–≥–∏: ${entry.totalSteps.toLocaleString()} / ${goal.toLocaleString()}</small>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${stepsPercent}%">
                            ${stepsPercent}%
                        </div>
                    </div>
                </div>
                <div class="treadmill-progress">
                    <div style="margin-bottom: 5px;">
                        <small>–î–æ—Ä–æ–∂–∫–∞: ${entry.treadmillSteps.toLocaleString()} / ${treadmillGoal.toLocaleString()}</small>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${treadmillPercent}%">
                            ${treadmillPercent}%
                        </div>
                    </div>
                </div>
            `;
            comparisonGrid.appendChild(card);
        });

        container.appendChild(comparisonGrid);
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤', err);
        container.innerHTML = '<p style="color:#ef4444;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</p>';
    }
};

// ===== –í–∫–ª–∞–¥–∫–∞ "–ò—Å—Ç–æ—Ä–∏—è" =====
const updateHistoryTab = async () => {
    if (!currentUser) return;
    const container = document.getElementById('history-content');

    try {
        const history = await loadHistoryForUser(currentUser.id);
        currentUserHistory = history;
        const dates = Object.keys(history).sort().reverse();

        if (!dates.length) {
            container.innerHTML = '<div class="empty-state">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞. –ù–∞—á–Ω–∏—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤–æ—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å!</div>';
            return;
        }

        const historyList = document.createElement('div');
        historyList.className = 'history-list';

        dates.forEach(dateKey => {
            const entry = history[dateKey];
            const date = new Date(dateKey);

            const stepsAchieved = entry.totalSteps >= entry.goal;
            const treadmillAchieved = entry.treadmillGoal === 0 || entry.treadmillSteps >= entry.treadmillGoal;

            let status = '';
            let statusClass = '';

            if (stepsAchieved && treadmillAchieved) {
                status = '–¶–µ–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚úÖ';
                statusClass = 'completed success';
            } else if (stepsAchieved || treadmillAchieved) {
                status = '–ß–∞—Å—Ç–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚ö†Ô∏è';
                statusClass = 'partial warning';
            } else {
                status = '–¶–µ–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚ùå';
                statusClass = 'failed error';
            }

            const item = document.createElement('div');
            item.className = `history-item ${statusClass}`;
            item.innerHTML = `
                <div class="history-date">${formatDate(date)}</div>
                <div class="history-stats">
                    <div class="history-stat">
                        –®–∞–≥–∏: <strong>${entry.totalSteps.toLocaleString()}</strong> / ${entry.goal.toLocaleString()}
                    </div>
                    <div class="history-stat">
                        –î–æ—Ä–æ–∂–∫–∞: <strong>${entry.treadmillSteps.toLocaleString()}</strong> / ${entry.treadmillGoal.toLocaleString()}
                    </div>
                </div>
                <span class="status-badge ${statusClass}">${status}</span>
            `;

            historyList.appendChild(item);
        });

        container.innerHTML = '';
        container.appendChild(historyList);
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏', err);
        container.innerHTML = '<p style="color:#ef4444;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é.</p>';
    }
};

// ===== –í–∫–ª–∞–¥–∫–∞ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" =====
const showStats = async (period) => {
    if (!currentUser) return;
    const container = document.getElementById('stats-content');

    try {
        const history = await loadHistoryForUser(currentUser.id);
        currentUserHistory = history;
        const allDates = Object.keys(history).sort();
        if (!allDates.length) {
            container.innerHTML = '<div class="empty-state">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
            return;
        }

        const today = new Date();
        let filteredDates = allDates;

        if (period === 'week') {
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            filteredDates = allDates.filter(d => new Date(d) >= weekAgo);
        } else if (period === 'month') {
            const monthAgo = new Date(today);
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            filteredDates = allDates.filter(d => new Date(d) >= monthAgo);
        } else if (period === 'day') {
            const todayKey = getTodayKey();
            filteredDates = allDates.filter(d => d === todayKey);
        }

        if (!filteredDates.length) {
            container.innerHTML = '<div class="empty-state">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
            return;
        }

        const totalSteps = filteredDates.reduce((sum, d) => sum + (history[d]?.totalSteps || 0), 0);
        const totalTreadmill = filteredDates.reduce((sum, d) => sum + (history[d]?.treadmillSteps || 0), 0);
        const avgSteps = Math.round(totalSteps / filteredDates.length);
        const avgTreadmill = Math.round(totalTreadmill / filteredDates.length);

        const goalsAchieved = filteredDates.filter(d => {
            const entry = history[d];
            return entry && entry.totalSteps >= entry.goal;
        }).length;

        const treadmillAchieved = filteredDates.filter(d => {
            const entry = history[d];
            return entry && (entry.treadmillGoal === 0 || entry.treadmillSteps >= entry.treadmillGoal);
        }).length;

        const maxSteps = Math.max(...filteredDates.map(d => history[d]?.totalSteps || 0));

        const statsHtml = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">–í—Å–µ–≥–æ —à–∞–≥–æ–≤</div>
                    <div class="stat-value">${totalSteps.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</div>
                    <div class="stat-value">${avgSteps.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–ú–∞–∫—Å–∏–º—É–º –∑–∞ –¥–µ–Ω—å</div>
                    <div class="stat-value">${maxSteps.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–¶–µ–ª–µ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                    <div class="stat-value">${goalsAchieved}/${filteredDates.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–î–æ—Ä–æ–∂–∫–∞: –≤—Å–µ–≥–æ</div>
                    <div class="stat-value">${totalTreadmill.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–î–æ—Ä–æ–∂–∫–∞: —Å—Ä–µ–¥–Ω–µ–µ</div>
                    <div class="stat-value">${avgTreadmill.toLocaleString()}</div>
                </div>
            </div>
        `;

        const allUsers = await fetchAllUsers();
        const chartHtml = await createComparisonChart(allUsers, filteredDates);

        container.innerHTML = statsHtml + chartHtml;
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', err);
        container.innerHTML = '<p style="color:#ef4444;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.</p>';
    }
};

const createComparisonChart = async (users, filteredDates) => {
    const chartData = [];

    for (const user of users) {
        const history = await loadHistoryForUser(user.id);
        const totalSteps = filteredDates.reduce(
            (sum, d) => sum + (history[d]?.totalSteps || 0),
            0
        );
        const totalTreadmill = filteredDates.reduce(
            (sum, d) => sum + (history[d]?.treadmillSteps || 0),
            0
        );
        chartData.push({
            name: user.name,
            steps: totalSteps,
            treadmill: totalTreadmill,
            isCurrentUser: currentUser && user.id === currentUser.id
        });
    }

    const maxValue = Math.max(...chartData.map(d => d.steps), 0) || 1;

    const barsHtml = chartData.map(data => {
        const height = maxValue > 0 ? (data.steps / maxValue * 100) : 0;
        const treadmillHeight = data.steps > 0 ? (data.treadmill / data.steps * height) : 0;

        return `
            <div class="bar-item">
                <div class="bar" style="height: ${height}%; ${data.isCurrentUser ? 'background: linear-gradient(180deg, #f59e0b 0%, #fbbf24 100%);' : ''}">
                    <div class="bar-value">${data.steps.toLocaleString()}</div>
                    <div style="position: absolute; bottom: 0; width: 100%; height: ${treadmillHeight}%; background: linear-gradient(180deg, #10b981 0%, #34d399 100%); border-radius: 8px 8px 0 0;"></div>
                </div>
                <div class="bar-label">${data.name}${data.isCurrentUser ? ' (–≤—ã)' : ''}</div>
            </div>
        `;
    }).join('');

    return `
        <div class="chart-container">
            <h3 style="margin-bottom: 20px; color: #8b5cf6;">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
            <div style="margin-bottom: 15px; font-size: 0.9em; color: #666;">
                <span style="display: inline-block; width: 15px; height: 15px; background: #8b5cf6; border-radius: 3px; margin-right: 5px;"></span> –û–±—â–∏–µ —à–∞–≥–∏
                <span style="display: inline-block; width: 15px; height: 15px; background: #10b981; border-radius: 3px; margin: 0 5px 0 15px;"></span> –®–∞–≥–∏ –Ω–∞ –¥–æ—Ä–æ–∂–∫–µ
            </div>
            <div class="bar-chart">
                ${barsHtml}
            </div>
        </div>
    `;
};

// ===== –í–∫–ª–∞–¥–∫–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" =====
const updateSettingsTab = async () => {
    if (!currentUser) return;
    document.getElementById('settings-base-steps').value = currentUser.baseSteps;
    document.getElementById('settings-treadmill-goal').value = currentUser.treadmillGoal;
};

const saveSettings = async () => {
    if (!currentUser) return;
    const baseSteps = parseInt(document.getElementById('settings-base-steps').value);
    const treadmillGoal = parseInt(document.getElementById('settings-treadmill-goal').value);

    if (isNaN(baseSteps) || baseSteps < 0) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –±–∞–∑–æ–≤—É—é –Ω–æ—Ä–º—É');
        return;
    }

    if (isNaN(treadmillGoal) || treadmillGoal < 0) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –Ω–æ—Ä–º—É –¥–æ—Ä–æ–∂–∫–∏');
        return;
    }

    try {
        await updateUserInFirestore(currentUser.id, {
            baseSteps,
            treadmillGoal
        });
        currentUser.baseSteps = baseSteps;
        currentUser.treadmillGoal = treadmillGoal;
        alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! ‚úÖ');
        await updateTodayTab();
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.');
    }
};

const deleteAccount = async () => {
    if (!currentUser) return;
    const user = currentUser;

    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç ${user.name}? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã!`)) {
        return;
    }

    if (!confirm('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
        return;
    }

    try {
        const userRef = doc(db, 'users', user.id);
        const historyCol = collection(db, 'users', user.id, 'history');
        const snap = await getDocs(historyCol);

        const batch = writeBatch(db);
        snap.forEach(d => batch.delete(d.ref));
        batch.delete(userRef);
        await batch.commit();

        clearCurrentUserId();
        currentUser = null;
        currentUserHistory = {};
        await init();
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç.');
    }
};

// –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è onclick
window.registerUser = registerUser;
window.loginUser = loginUser;
window.switchUser = () => { switchUser(); };
window.showTab = (tabName, btn) => { showTab(tabName, btn); };
window.saveToday = () => { saveToday(); };
window.editToday = () => { editToday(); };
window.showStats = (period) => { showStats(period); };
window.saveSettings = () => { saveSettings(); };
window.deleteAccount = () => { deleteAccount(); };

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
document.addEventListener('DOMContentLoaded', () => {
    init();
});
</script>

</body>
</html>
